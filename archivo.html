<!DOCTYPE html>
<html>

<head>
    <title>Archivo General OFRN</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
        }


        :host {
            font-size: 13px;
        }




        table {
            width: 100%;
            border-collapse: collapse;
        }

        .clear-filters-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .clear-filters-button:hover {
            background-color: #2980b9;
        }


        table th,
        table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 13px;
        }

        h3 {
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 25px;
            font-weight: bold;
            text-align: center;


        }

        th {
            background-color: #f4f4f4;
        }

        td a {
            text-decoration: none;
            color: blue;
        }

        td a.yt {
            color: red;
            font-weight: bold;
        }

        .filter-input {
            width: 95%;
            padding: 5px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .copy-button,
        .clear-button {
            margin-top: 10px;
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-button {
            background-color: #4CAF50;
        }

        .copy-button:hover {
            background-color: #45a049;
        }

        .clear-button {
            background-color: #f44336;
        }

        .clear-button:hover {
            background-color: #e53935;
        }

        .action-cell {
            text-align: center;
            cursor: move;
            font-weight: bold;
            font-size: 16px;
        }

        .highlight-row {
            background-color: #32CD32 !important;
        }

        .drag-handle {
            cursor: move;
            color: #888;
            font-size: 20px;
            padding: 0 8px;
        }

        /* Floating back to top button */
        #backToTopButton {
            width: 80px;
            height: 80px;
            font-size: 40px !important;
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0;
            /* Remove extra padding */
            font-size: 40px;
            /* Ensure consistent font size */
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-active {
            background-color: #191970;
            color: white;
            /* Optional: Ensure text is readable on dark background */
        }


        #backToTopButton:hover {
            opacity: 1;
        }

        #backToTopButton:focus {
            outline: none;
        }

        #instrumentFilters table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        #instrumentFilters th,
        #instrumentFilters td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }

        #instrumentFilters input {
            width: 100%;
            padding: 3px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }

        #instrumentFilters th {
            background-color: #f4f4f4;
        }

        .instrument-filter-select {
            -webkit-appearance: none;
            /* For Chrome, Safari, and newer Edge */
            -moz-appearance: none;
            /* For Firefox */
            appearance: none;
            /* Standard syntax */
            background: none;
            /* Removes any default background */
            padding: 3px;
            /* Adds padding for better spacing */
            font-size: 12px;
            /* Makes the text slightly larger */
            text-align: center;
            /* Centers the text inside */
            border: 1px solid #ccc;
            /* Adds a border */
            border-radius: 4px;
            /* Optional: Adds rounded corners */
            cursor: pointer;
            /* Adds a pointer cursor */
            width: 100%;
            /* Ensures the dropdown fits its container */
            box-sizing: border-box;
            /* Includes padding in width calculation */
        }

        /* Optional: Add a custom arrow as a background image */
        .instrument-filter-select::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-top-color: #000;
            /* Black arrow */
            pointer-events: none;
        }

        /* Styles for the filter buttons container */
        #filterButtons {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            /* Light background color for the container */
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #difficultyFilter {
            margin-left: 10px;
            /* Add some space between the buttons and the filter */
            display: flex;
            align-items: center;
            /* Align button and checkboxes */
            background-color: #f9f9f9;
            /* Lighter background for the difficulty filter */
            padding: 5px;
            border-radius: 4px;
        }

        #difficultyButton {
            margin-right: 10px;
            /* Space between button and checkboxes */
        }

        #difficultyOptions {
            display: none;
            flex-wrap: wrap;
        }

        #difficultyOptions label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        #difficultyOptions input[type="checkbox"] {
            margin-right: 5px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
    <h3>Obras seleccionadas</h3>
    <table id="auxTable">
        <thead>
            <tr>
                <th>&#x22EE;</th>
                <th>❌</th>
                <th>N°</th>

                <th>Link</th>
                <th>Compositor</th>
                <th>Arreglador</th>
                <th>Año</th>
                <th>Obra</th>
                <th>Palabras Clave</th>
                <th>País</th>
                <th>Duración</th>
                <th>Ensamble</th>
                <th>YouTube</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="copy-button" onclick="copyAllLinks()">Copiar links</button>
    <button class="clear-button" onclick="clearSelection()">Borrar selección</button>

    <h3 id="encabezadoArchivo">Archivo para filtrar </h3>
    <div id="filterButtons">
        <button id="clearFiltersButton" class="clear-filters-button" onclick="clearAllFilters()">Limpiar
            filtros</button>
        <button id="showInstrumentFiltersButton" class="clear-filters-button"
            onclick="toggleInstrumentFilters()">Mostrar filtros de instrumentos</button>

        <div id="difficultyFilter">
            <button id="difficultyButton" class="clear-filters-button"
                onclick="toggleDifficultyOptions()">Dificultad</button>
            <div id="difficultyOptions">
                <input type="checkbox" id="difficulty1" value="1" onchange="applyFilters()">
                <label for="difficulty1">1</label>
                <input type="checkbox" id="difficulty2" value="2" onchange="applyFilters()">
                <label for="difficulty2">2</label>
                <input type="checkbox" id="difficulty3" value="3" onchange="applyFilters()">
                <label for="difficulty3">3</label>
                <input type="checkbox" id="difficultyNone" value="" onchange="applyFilters()">
                <label for="difficultyNone">Sin categoría</label>
            </div>
        </div>
        <button id="cbrpButton" class="clear-filters-button" onclick="toggleCBRPFilter()">CBRP</button>
        <select id="predefinedSets" class="clear-filters-button" onchange="applyPredefinedSet()">

        </select>
    </div>

    <div id="instrumentFilters" style="display: none;">
        <table>
            <thead>
                <tr id="instrumentHeaders"></tr>
            </thead>
            <tbody>
                <tr id="instrumentInputs"></tr>
            </tbody>
        </table>
    </div>
    <div id="loading"></div>
    <table id="dataTable" style="display:none;">
        <thead>
            <tr>
                <th>Acción</th>
                <th>Link</th>
                <th>Compositor</th>
                <th>Arreglador</th>
                <th>Año</th>
                <th>Obra</th>
                <th>Palabras Clave</th>
                <th>País</th>
                <th>Duración</th>
                <th>Ensamble</th>
                <th>YouTube</th>
            </tr>
            <tr>
                <th></th>
                <th></th>
                <!-- Remove filter for the Link column -->
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th> <input class="filter-input" type="text" placeholder="1974-2000" onkeyup="applyFilters()"
                        id="filter-year"></th>

                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th> <input class="filter-input" type="text" placeholder="0:03:00-0:30:00" onkeyup="applyFilters()"
                        id="filter-duration"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Floating back to top button -->
    <button id="backToTopButton" onclick="scrollToTop()">⇧⇧</button>

    <script>
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYZpbc1MZvPLzQiwdgsC46D2uP3XlqbH5AIt7XQ2bsaKOE-hKHlLRojW4NDrD4XeJhLYoVj6jrSIfl/pubhtml?gid=0&single=true";
        let filteredData = [];
        let originalData = [];
        const selectedRows = new Set();
        let cbrpFilterActive = false; // Flag to track CBRP filter state

        const predefinedInstrumentSets = {
            "VS": {
                "Cuerdas": "",
                "Flauta": "1",
                "Clarinete": "1",
                "Fagot": "1",
                "Oboe": "1",
                "Corno": "0",
                "Trombón": "0",
                "Trompeta": "0",
                "Tuba": "0",

            },
            "PV": {
                "Cuerdas": "",
                "Flauta": "1",
                "Clarinete": "1",
                "Fagot": "1",
                "Oboe": "1",
                "Corno": "1",
                "Trombón": "0",
                "Trompeta": "0",
                "Tuba": "0",

            },
            "BRAT": {
                "Cuerdas": "",
                "Flauta": "0",
                "Clarinete": "0",
                "Fagot": "0",
                "Oboe": "0",
                "Corno": "0",
                "Trombón": "1",
                "Trompeta": "1",
                "Tuba": "1",
            },
            "ABRON": {
                "Cuerdas": "",
                "Flauta": "0",
                "Clarinete": "0",
                "Fagot": "0",
                "Oboe": "0",
                "Corno": "1",
                "Trombón": "2",
                "Trompeta": "2",
                "Tuba": "0",
            },
            "Cuerdas": {
                "Cuerdas": "Str",
                "Flauta": "0",
                "Clarinete": "0",
                "Fagot": "0",
                "Oboe": "0",
                "Corno": "0",
                "Trombón": "0",
                "Trompeta": "0",
                "Tuba": "0",
            },
            "CFMar": {
                "Cuerdas": "Str",
                "Flauta": "1",
                "Clarinete": "1",
                "Fagot": "1",
                "Oboe": "1",
                "Corno": "0",
                "Trombón": "1",
                "Trompeta": "1",
                "Tuba": "1",
            },
            "CFVal": {
                "Cuerdas": "Str",
                "Flauta": "1",
                "Clarinete": "1",
                "Fagot": "1",
                "Oboe": "1",
                "Corno": "1",
                "Trombón": "2",
                "Trompeta": "2",
                "Tuba": "0",
            },

        };

        async function fetchSheetData() {
            try {
                const response = await fetch(sheetUrl);
                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const rows = Array.from(doc.querySelectorAll("table tbody tr"));

                originalData = rows
                    .slice(1) // Skip the first line (headers in source)
                    .slice(1) // Skip another line if necessary
                    .map(row => Array.from(row.querySelectorAll("td")).map((cell, index) => {
                        if (index === 0 || index === 9) { // Adjust for your link columns
                            const anchor = cell.querySelector("a"); // Look for the <a> tag
                            if (anchor) {
                                const url = new URL(anchor.href);
                                return url.searchParams.get("q") || anchor.href; // Extract 'q' or fallback to the raw href
                            }
                            return "";
                        }
                        return cell.innerHTML.trim() || ""; // Keep other cells as raw HTML content
                    }))
                    .filter(row => row[0]); // Exclude rows with empty Column A

                filteredData = originalData;
                loadSelectedRowsFromLocalStorage();
                // Reapply styles to rows if necessary
                Array.from(selectedRows).forEach(row => {
                    const tr = document.querySelector(`[data-row-id="${row[1]}"]`); // Adjust selector to match your row identifier
                    if (tr) {
                        tr.classList.add("highlight-row");
                        const actionTd = tr.querySelector('.action-td'); // Adjust to match your action cell class
                        actionTd.textContent = "❌";
                    }
                });
                applyFilters();
                renderTable(filteredData);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('loading').textContent = 'Error cargando datos. Por favor, verifica la URL.';
            }
        }

        function renderTable(data0, sortColumn = null, sortDirection = 'asc') {
            let data = data0.map(row => row.slice(0, 10)); // Ensure only the first 10 columns are rendered
            //console.log("Sorting column:", sortColumn, "Direction:", sortDirection);
            //console.log("Data before sorting:", data);

            if (sortColumn !== null) {
                data.sort((a, b) => {
                    const valA = a[sortColumn] || '';
                    const valB = b[sortColumn] || '';

                    // Ensure empty values always go to the end
                    const isEmptyA = valA === '';
                    const isEmptyB = valB === '';

                    if (isEmptyA && !isEmptyB) return 1; // valA is empty, move it down
                    if (!isEmptyA && isEmptyB) return -1; // valB is empty, move it down

                    // Compare non-empty values
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;

                    // Handle tiebreaker (e.g., column 1 as secondary sort)
                    const tieBreakerA = a[4] || '';
                    const tieBreakerB = b[4] || '';
                    if (tieBreakerA < tieBreakerB) return sortDirection === 'asc' ? -1 : 1;
                    if (tieBreakerA > tieBreakerB) return sortDirection === 'asc' ? 1 : -1;

                    return 0; // Rows are completely equal
                });
            }

            const tbody = document.querySelector("#dataTable tbody");
            tbody.innerHTML = ""; // Clear existing rows

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';

            // Update table body
            data.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");
                const actionTd = document.createElement("td");
                actionTd.className = "action-cell";
                actionTd.textContent = "✔";

                if (Array.from(selectedRows).some(selectedRow => selectedRow[0] === row[0])) {
                    tr.className = "highlight-row";
                    actionTd.textContent = "❌"; // Change to "❌"
                }

                actionTd.addEventListener("click", () => selectRow(row, tr, actionTd));
                tr.appendChild(actionTd);

                row.forEach((cell, index) => {
                    const td = document.createElement("td");

                    if (index === 0) {
                        const a = document.createElement("a");
                        a.href = cell; // Use the cleaned URL
                        a.textContent = "🔗";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else if (index === 9 && cell) {
                        const a = document.createElement("a");
                        a.href = cell; // Use the cleaned URL
                        a.textContent = "YT";
                        a.className = "yt";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else {
                        td.innerHTML = cell; // Render raw HTML content for other cells
                    }


                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            // Update header colors
            const headersT = document.querySelectorAll("#dataTable thead tr:first-child th")


            // Apply background color to both header rows
            headersT.forEach((header, index) => {
                header.style.backgroundColor = '#f4f4f4'; // Default color
                if (index === (sortColumn + 1)) {
                    header.style.backgroundColor = sortDirection === 'asc' ? '#d4f8d4' : '#fce4d4';
                }
            });



            const encabezadoArchivo = document.getElementById("encabezadoArchivo");
            encabezadoArchivo.textContent = `Archivo General (${filteredData.length} / ${originalData.length})`;
        }

        // Add event listeners to headers
        document.querySelectorAll("#dataTable thead tr:first-child th").forEach((header, index) => {
            let sortDirection = 'asc'; // Default sorting direction
            header.addEventListener("click", () => {
                // Toggle sort direction
                console.log("Header clicked:", header.textContent);
                let data = filteredData;
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; // Toggle sort direction
                renderTable(data, index - 1, sortDirection); // Sort by the clicked column
            });
        });
        function saveSelectedRowsToLocalStorage() {
            localStorage.setItem('selectedRows', JSON.stringify(Array.from(selectedRows)));
            console.log("Saved rows to local storage");
            console.log(localStorage.getItem('selectedRows'));
        }
        function loadSelectedRowsFromLocalStorage() {
            const savedRows = localStorage.getItem('selectedRows');
            console.log("Loading selected rows")
            console.log(savedRows)
            if (savedRows) {
                const parsedRows = JSON.parse(savedRows);
                selectedRows.clear(); // Clear any existing rows
                parsedRows.forEach(row => selectedRows.add(row)); // Restore rows
            }
        }
        function selectRow(row, tr, actionTd) {
            const rowToDelete = Array.from(selectedRows).find(selectedRow => selectedRow[0] === row[0]);

            if (rowToDelete) {
                console.log("Borrar fila");
                selectedRows.delete(rowToDelete);
                tr.classList.remove("highlight-row");
                actionTd.textContent = "✔";
            } else {
                selectedRows.add(row);
                tr.classList.add("highlight-row");
                actionTd.textContent = "❌";
            }
            saveSelectedRowsToLocalStorage(); // Save changes to local storage
            updateAuxTable();
            applyFilters();
        }



        function updateAuxTable() {
            const auxTbody = document.querySelector("#auxTable tbody");

            auxTbody.innerHTML = "";

            // Initialize a variable to sum durations (in seconds)
            let totalDurationInSeconds = 0;

            Array.from(selectedRows).forEach((row, index) => {
                const tr = document.createElement("tr");

                // Create drag handle with three dots
                const dragHandleTd = document.createElement("td");
                dragHandleTd.className = "action-cell";
                dragHandleTd.innerHTML = "&#x22EE;"; // Three dots (vertical ellipsis)
                dragHandleTd.setAttribute("draggable", "true");
                tr.appendChild(dragHandleTd);

                // Create the action cell with "❌" button
                const actionTd = document.createElement("td");
                actionTd.className = "action-cell";
                actionTd.textContent = "❌";
                actionTd.addEventListener("click", () => deselectRow(row));
                tr.appendChild(actionTd);

                // Add ordinal number column
                const ordinalTd = document.createElement("td");
                ordinalTd.className = "ordinal-cell";
                ordinalTd.textContent = index + 1; // Ordinal number starts from 1
                tr.appendChild(ordinalTd);

                // Add the rest of the row's cells
                row.forEach((cell, cellIndex) => {
                    const td = document.createElement("td");

                    if (cellIndex === 0) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "🔗";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else if (cellIndex === 9 && cell) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "YT";
                        a.className = "yt";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else {
                        td.innerHTML = cell;

                        // If the cell is in the "Duración" column (index 7), convert to seconds and add to total
                        if (cellIndex === 7) {
                            totalDurationInSeconds += durationToSeconds(cell);
                        }
                    }

                    tr.appendChild(td);
                });

                auxTbody.appendChild(tr);
            });

            // Add a summary row for total duration
            const summaryRow = document.createElement("tr");
            summaryRow.className = "summary-row";

            // Empty cells for columns before "Duración"
            for (let i = 0; i < 10; i++) { // Adjust loop to leave 7 cells empty before the "Duración" column
                const emptyTd = document.createElement("td");
                summaryRow.appendChild(emptyTd);
            }

            // Total duration cell
            const totalDurationTd = document.createElement("td");
            totalDurationTd.textContent = secondsToDuration(totalDurationInSeconds); // Format as HH:MM:SS
            totalDurationTd.className = "total-duration-cell";
            summaryRow.appendChild(totalDurationTd);

            // Empty cells for columns after "Duración"
            for (let i = 0; i < 2; i++) { // Adjust loop to leave remaining cells empty after "Duración"
                const emptyTd = document.createElement("td");
                summaryRow.appendChild(emptyTd);
            }

            auxTbody.appendChild(summaryRow);

            // Make the rows sortable (works for both desktop and mobile)
            const sortable = new Sortable(auxTbody, {
                handle: '.action-cell', // Only the drag handle is used for dragging
                ghostClass: 'highlight-row', // Highlight while dragging
                onEnd: () => {
                    // Get the reordered rows from the table
                    const reorderedRows = Array.from(auxTbody.querySelectorAll("tr:not(.summary-row)")).map(tr => {
                        const cells = Array.from(tr.querySelectorAll("td"));
                        const rowData = [];

                        cells.forEach((cell, cellIndex) => {
                            if (cellIndex === 3) {
                                // Handle the first column (link cell)
                                const linkElement = cell.querySelector("a");
                                rowData.push(linkElement ? linkElement.href : null); // Store the actual link
                            } else if (cellIndex !== 2 && cellIndex !== 0 && cellIndex !== 1) {
                                // Skip action and ordinal cells
                                rowData.push(cell.textContent.trim());
                            }
                        });

                        return rowData;
                    });

                    // Clear and update selectedRows with the new order
                    selectedRows.clear();
                    reorderedRows.forEach(row => selectedRows.add(row));

                    // Update ordinal numbers
                    reorderedRows.forEach((row, index) => {
                        const ordinalCell = auxTbody.querySelectorAll("tr:not(.summary-row)")[index].querySelector(".ordinal-cell");
                        ordinalCell.textContent = index + 1; // Update the ordinal number
                    });

                    // Save the updated order to local storage
                    saveSelectedRowsToLocalStorage();
                }
            });



        }
        // Helper function to convert HH:MM:SS to seconds
        function durationToSeconds(duration) {
            if (!duration || !duration.includes(":")) {
                return 0; // Return 0 if duration is empty or does not contain ":"
            }

            const [hours, minutes, seconds] = duration.split(":").map(Number);
            return (hours || 0) * 3600 + (minutes || 0) * 60 + (seconds || 0);
        }


        // Helper function to convert seconds to HH:MM:SS
        function secondsToDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(1, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        }

        function deselectRow(row) {
            selectedRows.delete(row); // Remove the row from the set
            saveSelectedRowsToLocalStorage(); // Save changes to local storage
            updateAuxTable();
            applyFilters();
        }

        function clearAllFilters() {
            // Clear all filter inputs
            const inputs = document.querySelectorAll(".filter-input");
            inputs.forEach(input => {
                input.value = ""; // Clear the value
                input.parentElement.classList.remove("input-active"); // Remove background color
            });
            const instInputs = document.querySelectorAll(".instrument-filter-input");
            instInputs.forEach(input => {
                input.value = ""; // Clear the value
                input.parentElement.classList.remove("input-active"); // Remove background color
            });
            // Reset all dropdowns (select elements) to empty and gray background
            const selects = document.querySelectorAll(".instrument-filter-select");
            selects.forEach(select => {
                select.style.background = ""; // Reset gradient background
                select.style.color = ""; // Reset text color
                select.value = ""; // Reset the value to empty
                select.style.backgroundColor = "#E5E4E2"; // Set the background to gray
                select.style.color = ""; // Reset text color
            });
            // Clear difficulty checkboxes
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`difficulty${i}`).checked = false;
            }
            document.getElementById('difficultyNone').checked = false;
            // Clear CBRP filter
            if (cbrpFilterActive) {
                const cbrpButton = document.getElementById("cbrpButton");
                cbrpButton.style.backgroundColor = "#3498db"; // Reset button color
                cbrpFilterActive = false;
            }
            document.getElementById("predefinedSets").value = "Seleccionar Ensamble";

            // Reset the table to show all data
            applyFilters()
        }

        function toggleCBRPFilter() {
            cbrpFilterActive = !cbrpFilterActive; // Toggle the filter state
            const cbrpButton = document.getElementById("cbrpButton");

            if (cbrpFilterActive) {
                cbrpButton.style.backgroundColor = "green"; // Change to green when active
            } else {
                cbrpButton.style.backgroundColor = "#3498db"; // Back to default color
            }

            applyFilters(); // Reapply filters
        }


        function applyFilters() {
            console.log("Apply filters");

            // Get year and duration filters
            const yearFilter = document.getElementById('filter-year').value.trim();
            const durationFilter = document.getElementById('filter-duration').value.trim();
            // Difficulty filter (using checkboxes)
            const selectedDifficulties = [];
            for (let i = 1; i <= 3; i++) {
                const checkbox = document.getElementById(`difficulty${i}`);
                if (checkbox.checked) {
                    selectedDifficulties.push(checkbox.value);
                }
            }
            const noCategoryCheckbox = document.getElementById('difficultyNone');
            if (noCategoryCheckbox.checked) {
                selectedDifficulties.push(''); // Add empty string for "Sin categoría"
            }


            // Instrument filters with dropdown logic
            const instrumentFilters = Array.from(document.querySelectorAll(".instrument-filter-input"))
                .map((input, index) => {
                    const td = input.parentElement; // Get the parent <td>
                    const select = td.querySelector(".instrument-filter-select"); // Get the associated dropdown
                    const filterType = select?.value; // Get the selected filter type
                    const filterValue = input.value.trim(); // Get the input value

                    if (filterType) {
                        td?.classList.add("input-active"); // Add background if input has a value
                    } else {
                        td?.classList.remove("input-active"); // Remove background if input is empty
                    }

                    /*console.log(
                        `Instrument Filter Input [${index}]:`,
                        `Type: ${filterType}, Value: ${filterValue}`,
                        td
                    );*/

                    // Return filter data if both type and value are provided
                    return { type: filterType, value: filterValue, colIndex: index + 15 } // Adjust index for instrument columns
                        ;
                })
                .filter(filter => filter); // Remove null entries

            //console.log("Instrument Filters:", instrumentFilters);

            // Standard text-based filters
            const filters = Array.from(document.querySelectorAll(".filter-input"))
                .map((input, index) => {
                    const td = input.parentElement; // Get the parent <td>
                    if (input.value.trim()) {
                        td?.classList.add("input-active"); // Add background if input has a value
                    } else {
                        td?.classList.remove("input-active"); // Remove background if input is empty
                    }
                    return input.id !== "filter-year" && input.id !== "filter-duration"
                        ? { value: input.value.toLowerCase(), colIndex: index }
                        : null;
                })
                .filter(filter => filter !== null);

            //console.log("Text Filters:", filters);

            // Apply all filters
            filteredData = originalData.filter(row => {
                // Standard text-based filtering
                const matchesTextFilters = filters.every(filter =>
                    !filter.value || row[filter.colIndex + 1].toLowerCase().includes(filter.value)
                );

                // Range-based filtering for "Año"
                const yearMatch = !yearFilter || filterYearRange(row[3], yearFilter);

                // Range-based filtering for "Duración"
                const durationMatch = !durationFilter || filterDurationRange(row[7], durationFilter);

                // Instrument-specific filtering
                const matchesInstrumentFilters = instrumentFilters.every(filter => {
                    const value = row[filter.colIndex] || ""; // Handle empty cells gracefully

                    // Pass filter type and value to matchesInstrumentFilter
                    return matchesInstrumentFilter(value, filter.type, filter.value);
                });
                const isCBRP = cbrpFilterActive ? (row[45].toLowerCase().includes("sí")) : true; // Corrected comparison
                //console.log(row[45])
                //console.log(isCBRP)
                // Difficulty filtering
                const difficultyMatch = selectedDifficulties.length === 0 ||
                    selectedDifficulties.includes(row[44]) || // Assuming difficulty is in column 45 (index 44)
                    (row[44] === "" && selectedDifficulties.includes("")); // Check for empty difficulty

                return matchesTextFilters && yearMatch && durationMatch && matchesInstrumentFilters && difficultyMatch && isCBRP;
            });
            //console.log("Filtered Data:", filteredData);
            // Update the header with the filtered data count
            // Apply CBRP filter if active


            renderTable(filteredData);
            updateAuxTable()

        }

        function matchesInstrumentFilter(cellValue, filterType, filterValue) {
            // Special handling for "=" with empty filter value


            // First, check if the filter and cell value are numeric
            const numericValue = parseInt(filterValue, 10);
            const cellNumericValue = parseInt(cellValue, 10);
            // Special handling for "=" with empty filter value
            if (filterType === "equal" && filterValue.trim() === "") {
                const numericCellValue = parseInt(cellValue, 10);
                return cellValue.trim() === "" || numericCellValue === 0; // Check for empty string or 0
                console.log("Valor vacío ")
            }

            else if ((!isNaN(numericValue) && !isNaN(cellNumericValue)) || filterType === "none") {

                // Handle numeric comparisons
                switch (filterType) {
                    case "none":
                        // Check if the cell is empty or explicitly zero
                        return cellNumericValue === 0;
                    case "equal":
                        return cellNumericValue === numericValue;
                    case "less_than":
                        return cellNumericValue < numericValue;
                    case "greater_than":
                        return cellNumericValue > numericValue;
                    case "less_equal":
                        return cellNumericValue <= numericValue;
                    case "greater_equal":
                        return cellNumericValue >= numericValue;
                    default:
                        return true;
                }
            } else {
                // Handle string comparisons (always using includes with lowercase)
                const normalizedFilterValue = filterValue.trim().toLowerCase();
                const normalizedCellValue = cellValue ? cellValue.trim().toLowerCase() : "";

                // Always use "includes" for string comparisons (case-insensitive)
                return normalizedCellValue.includes(normalizedFilterValue);
            }
        }

        function toggleInstrumentFilters() {
            const filterDiv = document.getElementById("instrumentFilters");
            filterDiv.style.display = filterDiv.style.display === "none" ? "block" : "none";

            const button = document.getElementById("showInstrumentFiltersButton");
            const filtersRow = document.getElementById("instrumentInputs");

            // Toggle visibility of the filters row
            if (filtersRow.style.display === "none" || !filtersRow.style.display) {
                filtersRow.style.display = "table-row"; // Show the filters row
                button.textContent = "Ocultar filtros de instrumentos"; // Update button text
            } else {
                filtersRow.style.display = "none"; // Hide the filters row
                button.textContent = "Mostrar filtros de instrumentos"; // Update button text
            }
        }
        const headers = [
            "Cuerdas", "Flauta", "Fl", "Oboe", "Ob", "Clarinete", "Clarinete Bajo", "Fagot", "", "Corno", "",
            "Trompeta", "", "Trombón", "", "Tuba", "", "Percusión", "", "Arpa", "Piano", "Coro", "Guitarra",
            "Charango", "Órgano", "Añadidos", "Solista", "", "OBSERVACIONES"
        ];
        function generateInstrumentFilters() {


            const headerRow = document.getElementById("instrumentHeaders");
            const inputRow = document.getElementById("instrumentInputs");

            headerRow.innerHTML = ""; // Clear existing headers
            inputRow.innerHTML = "";  // Clear existing inputs

            headers.forEach((header, index) => {
                // Create header cell
                const th = document.createElement("th");
                th.textContent = header.trim();
                if (!header.trim()) {
                    th.style.display = "none"; // Hide empty column headers
                }
                headerRow.appendChild(th);

                // Create input cell
                const td = document.createElement("td");

                // Create a dropdown for filter options
                const select = document.createElement("select");
                select.classList.add("instrument-filter-select");
                select.style.backgroundColor = "#E5E4E2";
                select.style.width = "40px"; // Adjust width as needed
                select.style.textAlign = "center"; // Center the text inside the select
                select.style.textAlignLast = "center"; // Ensures dropdown text alignment for some browsers
                select.style.display = "block"; // Ensures block-level alignment for centering
                select.style.margin = "0 auto"; // Centers the select element within its container


                // Add filter options
                const options = [
                    { value: "none", text: "⊘" },   // No value or not containing anything
                    { value: "equal", text: "=" },  // Equal to
                    { value: "less_than", text: "<" },  // Less than
                    { value: "greater_than", text: ">" },  // Greater than
                    { value: "less_equal", text: "<=" },  // Less than or equal to
                    { value: "greater_equal", text: ">=" } // Greater than or equal to
                ];

                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.textContent = "";
                select.appendChild(placeholderOption);

                options.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.textContent = option.text;
                    select.appendChild(opt);
                });
                select.addEventListener('change', function () {

                    // Check if "none" option is selected
                    //console.log(this.value)
                    if (this.value === "none") {

                        // Find the associated input element and set its value to "0"
                        const input = this.closest('td').querySelector('input'); // Find the <input> inside the parent <td>
                        if (input) {
                            input.value = "0"; // Set the input value to "0"
                        }
                    }

                    applyFilters();  // Trigger the filter function when selection changes


                })
                // Add coloring for the options in the dropdown
                const optionsD = select.querySelectorAll('option');
                // Add coloring for the options in the dropdown

                optionsD.forEach(option => {
                    // Reset background and text color for each option
                    option.style.backgroundColor = "";
                    option.style.color = "";

                    // Apply the specific logic to each option based on its value
                    switch (option.value) {
                        case "none":
                            option.style.backgroundColor = "black";
                            option.style.color = "white";
                            break;
                        case "equal":
                            option.style.backgroundColor = "blue";
                            option.style.color = "white";
                            break;
                        case "less_than":
                            option.style.backgroundColor = "red";
                            option.style.color = "white";
                            break;
                        case "greater_than":
                            option.style.backgroundColor = "green";
                            option.style.color = "white";
                            break;
                        case "less_equal":
                            option.style.backgroundColor = "gray"; // Use a solid color instead of a gradient
                            option.style.color = "white";
                            break;
                        case "greater_equal":
                            option.style.backgroundColor = "purple"; // Use a solid color instead of a gradient
                            option.style.color = "white";
                            break;
                        default:
                            option.style.backgroundColor = ""; // Reset background if no match
                            option.style.color = ""; // Reset text color if no match
                            break;
                    }
                });

                // Add styles for dropdown options
                select.onchange = function () {
                    // Reset the background and color first to avoid issues with gradients
                    select.style.backgroundColor = ""; // Reset background color
                    select.style.background = ""; // Reset gradient background
                    select.style.color = ""; // Reset text color

                    // Switch case to apply the appropriate color scheme
                    switch (select.value) {
                        case "none":
                            select.style.backgroundColor = "black";
                            select.style.color = "white";
                            break;
                        case "equal":
                            select.style.backgroundColor = "blue";
                            select.style.color = "white";
                            break;
                        case "less_than":
                            select.style.backgroundColor = "red";
                            select.style.color = "white";
                            break;
                        case "greater_than":
                            select.style.backgroundColor = "green";
                            select.style.color = "white";
                            break;
                        case "less_equal":
                            select.style.background = "linear-gradient(to right, red, blue)";
                            select.style.color = "white";
                            break;
                        case "greater_equal":
                            select.style.background = "linear-gradient(to right, blue, green)";
                            select.style.color = "white";
                            break;
                        default:
                            select.style.backgroundColor = ""; // Clear background if no match
                            select.style.color = ""; // Clear color if no match
                            break;
                    }
                };


                // Create an input box for the value
                const input = document.createElement("input");
                input.type = "text"; // Allow both numbers and strings
                input.classList.add("instrument-filter-input");
                input.placeholder = "...";
                input.style.width = "30px"; // Set the width in pixels
                input.style.textAlign = "center"; // Center the text inside the input box
                input.style.display = "block"; // Ensures block-level alignment for centering
                input.style.margin = "0 auto"; // Centers the input box within its container

                // Add event listener for changes
                input.onkeyup = function () {
                    // Check if input has a value and no option is selected in the dropdown
                    const selectedOption = select.value;
                    if (input.value.trim() && !selectedOption) {
                        select.style.backgroundColor = "blue";
                        select.style.color = "white";
                        select.value = "equal"; // Set the dropdown to "equal" if input has a value and no option is selected
                        applyFilters(); // Call applyFilters again after changing the select value
                    }
                    // Trigger applyFilters when input value changes
                    applyFilters();


                };
                // Append elements to the table cell
                td.appendChild(select);
                td.appendChild(input);
                if (!header.trim()) {
                    td.style.display = "none"; // Hide input cells for empty columns
                }
                inputRow.appendChild(td);
            });
            // Assuming you have your predefinedInstrumentSets object defined somewhere

            const dropdown = document.getElementById("predefinedSets");

            // Clear existing options (optional)
            dropdown.innerHTML = '<option value="">Seleccionar Ensamble</option>';

            // Add options dynamically
            for (const setName in predefinedInstrumentSets) {
                const option = document.createElement("option");
                option.value = setName;
                option.textContent = setName;
                dropdown.appendChild(option);
            }
        }

        function filterYearRange(yearValue, range) {
            const year = parseInt(yearValue.trim(), 10); // Extract the year as an integer
            if (isNaN(year)) return false; // Skip invalid data

            const [start, end] = range.split('-').map(val => val.trim());
            if (range.includes('-')) {
                const startYear = start ? parseInt(start, 10) : null;
                const endYear = end ? parseInt(end, 10) : null;

                if (start && end) return year >= startYear && year <= endYear; // Range
                if (start) return year >= startYear; // From a specific year onward
                if (end) return year <= endYear; // Up to a specific year
            }

            // Exact match
            return year === parseInt(range, 10);
        }

        generateInstrumentFilters()
        function filterDurationRange(durationValue, range) {
            const parseDuration = (time) => {
                const [h = 0, m = 0, s = 0] = time.split(':').map(Number);
                return h * 3600 + m * 60 + s;
            };

            const duration = parseDuration(durationValue.trim());
            if (isNaN(duration)) return false; // Skip invalid data

            const [start, end] = range.split('-').map(val => val.trim());
            if (range.includes('-')) {
                const startDuration = start ? parseDuration(start) : null;
                const endDuration = end ? parseDuration(end) : null;

                if (start && end) return duration >= startDuration && duration <= endDuration; // Range
                if (start) return duration >= startDuration; // From a specific duration onward
                if (end) return duration <= endDuration; // Up to a specific duration
            }

            // Exact match
            return duration === parseDuration(range);
        }


        function clearSelection() {
            selectedRows.clear(); // Clear all selected rows
            saveSelectedRowsToLocalStorage(); // Save changes to local storage
            updateAuxTable();
            applyFilters();
        }
        document.addEventListener('DOMContentLoaded', () => {

        });

        document.addEventListener('keydown', (event) => {
            // Check if Ctrl+C is pressed
            if (event.ctrlKey && event.key === 'c') {
                const selectedText = window.getSelection().toString().trim(); // Get selected text
                if (!selectedText) { // Only run if no text is selected
                    event.preventDefault(); // Prevent the default copy behavior
                    copyAllLinks();
                }
            }
        });


        function copyAllLinks() {
            const auxTableRows = Array.from(document.querySelector("#auxTable tbody").children);

            // Get the links from the third column in the aux table (the third column should contain the links)
            const links = auxTableRows.map((row, index) => {
                const linkCell = row.querySelector("td:nth-child(4) a"); // Grab the link in the third column
                if (linkCell) {
                    return linkCell.href;
                }
                return null;
            }).filter(link => link !== null); // Filter out any null values

            // Ensure that there's at least one link to copy
            if (links.length > 0) {
                navigator.clipboard.writeText(links.join("\n")).then(() => {
                    alert("Links copiados al portapapeles!");
                }).catch((error) => {
                    console.error("Error copying to clipboard: ", error);
                    alert("Hubo un error al copiar los links. Intenta nuevamente.");
                });
            } else {
                alert("No hay links seleccionados.");
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        fetchSheetData();
        // Function to get URL parameter value
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Set the value of the second filter input with URL parameter c
        function setFilterFromUrl() {
            const filterValue = getUrlParameter('c'); // Get the value of 'c' parameter
            if (filterValue) {
                const encodedValue = decodeURIComponent(filterValue); // Decode URL encoding for special characters
                document.querySelectorAll('.filter-input')[0].value = encodedValue; // Set the value of second input
            }
        }
        function applyPredefinedSet() {
            const selectedSet = document.getElementById("predefinedSets").value;
            console.log(selectedSet)
            if (selectedSet === "") {
                clearAllFilters()
            }
            else {
                const selectedSetFilters = predefinedInstrumentSets[selectedSet] || {}; // Get filters for selected set

                // Update the instrument filter inputs and dropdowns
                const instrumentInputs = document.querySelectorAll(".instrument-filter-input");
                const instrumentSelects = document.querySelectorAll(".instrument-filter-select"); // Get the select elements

                instrumentInputs.forEach((input, index) => {
                    const instrumentName = headers[index].trim(); // Get the instrument name from the header

                    // Only update if the instrument is in the selected set
                    if (instrumentName in selectedSetFilters) {
                        const filterValue = selectedSetFilters[instrumentName] || ""; // Get the predefined value or keep it empty

                        input.value = filterValue; // Update the input value

                        // Set the corresponding select element to "=" (equal)
                        instrumentSelects[index].value = "equal";
                        instrumentSelects[index].style.backgroundColor = "blue";
                        instrumentSelects[index].style.color = "white";
                    }
                });
            }

            applyFilters(); // Reapply filters
        }
        function toggleDifficultyOptions() {
            const optionsDiv = document.getElementById("difficultyOptions");
            const difficultyFilter = document.getElementById("difficultyFilter");

            if (optionsDiv.style.display === "none") {
                optionsDiv.style.display = "flex";
                difficultyFilter.style.backgroundColor = "#b2d0f1"; // Change background color when shown
            } else {
                optionsDiv.style.display = "none";
                difficultyFilter.style.backgroundColor = "#f9f9f9"; // Change back to original color when hidden
                // Call the function on page load
                window.onload = function () {
                    setFilterFromUrl(); // Apply the URL parameter to the filter input field
                };
            }
        }
    </script>
</body>

</html>