<!DOCTYPE html>
<html>

<head>
    <title>Archivo General OFRN</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        .clear-filters-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .clear-filters-button:hover {
            background-color: #2980b9;
        }


        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background-color: #f4f4f4;
        }

        td a {
            text-decoration: none;
            color: blue;
        }

        td a.yt {
            color: red;
            font-weight: bold;
        }

        .filter-input {
            width: 95%;
            padding: 5px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .copy-button,
        .clear-button {
            margin-top: 10px;
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-button {
            background-color: #4CAF50;
        }

        .copy-button:hover {
            background-color: #45a049;
        }

        .clear-button {
            background-color: #f44336;
        }

        .clear-button:hover {
            background-color: #e53935;
        }

        .action-cell {
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .highlight-row {
            background-color: #32CD32 !important;
        }

        .drag-handle {
            cursor: move;
            color: #888;
            font-size: 20px;
            padding: 0 8px;
        }

        /* Floating back to top button */
        #backToTopButton {
            width: 80px;
            height: 80px;
            font-size: 40px !important;
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0;
            /* Remove extra padding */
            font-size: 40px;
            /* Ensure consistent font size */
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-active {
            background-color: #191970;
            color: white;
            /* Optional: Ensure text is readable on dark background */
        }


        #backToTopButton:hover {
            opacity: 1;
        }

        #backToTopButton:focus {
            outline: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
    <h3>Obras seleccionadas</h3>
    <table id="auxTable">
        <thead>
            <tr>
                <th>.</th>
                <th>‚ùå</th>
                <th>Link</th>
                <th>Compositor</th>
                <th>Arreglador</th>
                <th>A√±o</th>
                <th>Obra</th>
                <th>Palabras Clave</th>
                <th>Pa√≠s</th>
                <th>Duraci√≥n</th>
                <th>Ensamble</th>
                <th>YouTube</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="copy-button" onclick="copyAllLinks()">Copiar links</button>
    <button class="clear-button" onclick="clearSelection()">Borrar selecci√≥n</button>

    <h3>Archivo para filtrar
        <button id="clearFiltersButton" class="clear-filters-button" onclick="clearAllFilters()">Limpiar
            filtros</button>
    </h3>

    <div id="loading"></div>
    <table id="dataTable" style="display:none;">
        <thead>
            <tr>
                <th>Acci√≥n</th>
                <th>Link</th>
                <th>Compositor</th>
                <th>Arreglador</th>
                <th>A√±o</th>
                <th>Obra</th>
                <th>Palabras Clave</th>
                <th>Pa√≠s</th>
                <th>Duraci√≥n</th>
                <th>Ensamble</th>
                <th>YouTube</th>
            </tr>
            <tr>
                <th></th>
                <th></th>
                <!-- Remove filter for the Link column -->
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th> <input class="filter-input" type="text" placeholder="1974-2000" onkeyup="applyFilters()"
                        id="filter-year"></th>

                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
                <th> <input class="filter-input" type="text" placeholder="0:03:00-0:30:00" onkeyup="applyFilters()"
                        id="filter-duration"></th>
                <th><input class="filter-input" type="text" placeholder="Inserte valor" onkeyup="applyFilters()"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Floating back to top button -->
    <button id="backToTopButton" onclick="scrollToTop()">‚áß‚áß</button>

    <script>
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYZpbc1MZvPLzQiwdgsC46D2uP3XlqbH5AIt7XQ2bsaKOE-hKHlLRojW4NDrD4XeJhLYoVj6jrSIfl/pubhtml?gid=0&single=true";

        let originalData = [];
        const selectedRows = new Set();

        async function fetchSheetData() {
            try {
                const response = await fetch(sheetUrl);
                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const rows = Array.from(doc.querySelectorAll("table tbody tr"));

                originalData = rows
                    .slice(1) // Skip the first line (headers in source)
                    .slice(1)
                    .map(row => Array.from(row.querySelectorAll("td")).slice(0, 10).map(cell => cell.innerText.trim() || ""))
                    .filter(row => row[0]); // Exclude rows with empty Column A

                renderTable(originalData);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('loading').textContent = 'Error cargando datos. Por favor, verifica la URL.';
            }
        }

        function renderTable(data) {
            const tbody = document.querySelector("#dataTable tbody");
            tbody.innerHTML = ""; // Clear existing rows

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';

            data.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");

                // Highlight if selected
                if (selectedRows.has(row)) {
                    tr.className = "highlight-row";
                }

                // Add "‚úî" action column
                const actionTd = document.createElement("td");
                actionTd.className = "action-cell";
                actionTd.textContent = "‚úî";
                actionTd.addEventListener("click", () => selectRow(row, tr));
                tr.appendChild(actionTd);

                row.forEach((cell, index) => {
                    const td = document.createElement("td");

                    if (index === 0) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "üîó";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else if (index === 9 && cell) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "YT";
                        a.className = "yt";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else {
                        td.textContent = cell;
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function selectRow(row, tr) {
            selectedRows.add(row);
            tr.classList.add("highlight-row");
            updateAuxTable();
        }

        function updateAuxTable() {
            const auxTbody = document.querySelector("#auxTable tbody");
            auxTbody.innerHTML = "";

            Array.from(selectedRows).forEach(row => {
                const tr = document.createElement("tr");

                // Create drag handle with three dots
                const dragHandleTd = document.createElement("td");
                dragHandleTd.className = "action-cell";
                dragHandleTd.innerHTML = "&#x22EE;"; // Three dots (vertical ellipsis)
                dragHandleTd.setAttribute("draggable", "true");
                tr.appendChild(dragHandleTd);

                const actionTd = document.createElement("td");
                actionTd.className = "action-cell";
                actionTd.textContent = "‚ùå";
                actionTd.addEventListener("click", () => deselectRow(row));
                tr.appendChild(actionTd);

                row.forEach((cell, index) => {
                    const td = document.createElement("td");

                    if (index === 0) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "üîó";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else if (index === 9 && cell) {
                        const a = document.createElement("a");
                        a.href = cell;
                        a.textContent = "YT";
                        a.className = "yt";
                        a.target = "_blank";
                        td.appendChild(a);
                    } else {
                        td.textContent = cell;
                    }

                    tr.appendChild(td);
                });

                auxTbody.appendChild(tr);
            });

            // Make the rows sortable
            new Sortable(auxTbody, {
                handle: '.action-cell', // This makes only the dots column draggable
                ghostClass: 'highlight-row',
            });
        }

        function deselectRow(row) {
            selectedRows.delete(row);
            updateAuxTable();
            renderTable(originalData);
        }
        function clearAllFilters() {
            // Clear all filter inputs
            const inputs = document.querySelectorAll(".filter-input");
            inputs.forEach(input => {
                input.value = ""; // Clear the value
                input.parentElement.classList.remove("input-active"); // Remove background color
            });

            // Reset the table to show all data
            renderTable(originalData);
        }

        function applyFilters() {
            const yearFilter = document.getElementById('filter-year').value.trim();
            const durationFilter = document.getElementById('filter-duration').value.trim();

            // Handle text inputs and exclude year/duration
            const filters = Array.from(document.querySelectorAll(".filter-input"))
                .map((input, index) => {
                    const td = input.parentElement; // Get the parent <td>
                    if (input.value.trim()) {
                        td.classList.add("input-active"); // Add background if input has a value
                    } else {
                        td.classList.remove("input-active"); // Remove background if input is empty
                    }
                    // Exclude year and duration filters
                    return input.id !== "filter-year" && input.id !== "filter-duration" ? { value: input.value.toLowerCase(), colIndex: index } : null;
                })
                .filter(filter => filter !== null);

            // Apply filters
            const filteredData = originalData.filter(row => {
                // Standard text-based filtering
                const matchesTextFilters = filters.every(filter => !filter.value || row[filter.colIndex + 1].toLowerCase().includes(filter.value));

                // Range-based filtering for "A√±o"
                const yearMatch = !yearFilter || filterYearRange(row[3], yearFilter);

                // Range-based filtering for "Duraci√≥n"
                const durationMatch = !durationFilter || filterDurationRange(row[7], durationFilter);

                return matchesTextFilters && yearMatch && durationMatch;
            });

            renderTable(filteredData);
        }

        function filterYearRange(yearValue, range) {
            const year = parseInt(yearValue.trim(), 10); // Extract the year as an integer
            if (isNaN(year)) return false; // Skip invalid data

            const [start, end] = range.split('-').map(val => val.trim());
            if (range.includes('-')) {
                const startYear = start ? parseInt(start, 10) : null;
                const endYear = end ? parseInt(end, 10) : null;

                if (start && end) return year >= startYear && year <= endYear; // Range
                if (start) return year >= startYear; // From a specific year onward
                if (end) return year <= endYear; // Up to a specific year
            }

            // Exact match
            return year === parseInt(range, 10);
        }


        function filterDurationRange(durationValue, range) {
            const parseDuration = (time) => {
                const [h = 0, m = 0, s = 0] = time.split(':').map(Number);
                return h * 3600 + m * 60 + s;
            };

            const duration = parseDuration(durationValue.trim());
            if (isNaN(duration)) return false; // Skip invalid data

            const [start, end] = range.split('-').map(val => val.trim());
            if (range.includes('-')) {
                const startDuration = start ? parseDuration(start) : null;
                const endDuration = end ? parseDuration(end) : null;

                if (start && end) return duration >= startDuration && duration <= endDuration; // Range
                if (start) return duration >= startDuration; // From a specific duration onward
                if (end) return duration <= endDuration; // Up to a specific duration
            }

            // Exact match
            return duration === parseDuration(range);
        }


        function clearSelection() {
            selectedRows.clear();
            updateAuxTable();
            renderTable(originalData);
        }

        function copyAllLinks() {
            const auxTableRows = Array.from(document.querySelector("#auxTable tbody").children);

            // Get the links from the third column in the aux table (the third column should contain the links)
            const links = auxTableRows.map((row, index) => {
                const linkCell = row.querySelector("td:nth-child(3) a"); // Grab the link in the third column
                if (linkCell) {
                    return linkCell.href;
                }
                return null;
            }).filter(link => link !== null); // Filter out any null values

            // Ensure that there's at least one link to copy
            if (links.length > 0) {
                navigator.clipboard.writeText(links.join("\n")).then(() => {
                    alert("Links copiados al portapapeles!");
                }).catch((error) => {
                    console.error("Error copying to clipboard: ", error);
                    alert("Hubo un error al copiar los links. Intenta nuevamente.");
                });
            } else {
                alert("No hay links seleccionados.");
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        fetchSheetData();
    </script>
</body>

</html>