<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Orquesta - Supabase</title>
    
    <!-- 1. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Cargar Babel (para entender JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Cargar Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .checkbox-wrapper input:checked + div {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Toggle Switch personalizado */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="root" class="h-full flex flex-col"></div>

    <!-- Tu Código React va aquí dentro -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CREDENCIALES FIJAS ---
        const SB_URL = "https://muxrbuivopnawnxlcjxq.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11eHJidWl2b3BuYXdueGxjanhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODI5MzIsImV4cCI6MjA4MDM1ODkzMn0._tMDAJg2r5vfR1y0JPYd3LVDB66CcyXtj5dY4RqrxIg";

        // --- ICONOS SVG ---
        const IconUsers = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>);
        const IconMusic = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>);
        const IconDatabase = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>);
        const IconSearch = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>);
        const IconEdit = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>);
        const IconCheck = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>);
        const IconX = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>);
        const IconFilter = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>);
        const IconChevronDown = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>);
        const IconPlus = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>);
        const IconAlertCircle = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>);
        const IconLayers = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>);
        const IconTrash = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>);
        const IconLoader = ({size=24, className=""}) => (<svg className={`animate-spin ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>);

        // --- COMPONENTE DE FILTRO MULTI-SELECT ---
        const InstrumentFilter = ({ catalogo, selectedIds, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const toggleSelection = (id) => {
                const newSelection = new Set(selectedIds);
                if (newSelection.has(id)) newSelection.delete(id);
                else newSelection.add(id);
                onChange(newSelection);
            };

            const selectAll = () => {
                const allIds = new Set(catalogo.map(c => c.id));
                allIds.add('null');
                onChange(allIds);
            };

            const deselectAll = () => onChange(new Set());

            const count = selectedIds.size;
            const total = catalogo.length + 1;

            return (
                <div className="relative" ref={dropdownRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between gap-2 px-3 py-2 bg-white border border-slate-300 rounded hover:border-indigo-500 transition-colors text-sm font-medium text-slate-700 shadow-sm">
                        <div className="flex items-center gap-2">
                            <IconFilter size={16} className="text-indigo-600"/>
                            <span>Instrumentos</span>
                            {count < total && (<span className="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full">{count}</span>)}
                        </div>
                        <IconChevronDown size={16} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
                    </button>
                    {isOpen && (
                        <div className="absolute top-full right-0 mt-2 w-72 bg-white border border-slate-200 rounded-lg shadow-xl z-50 overflow-hidden flex flex-col max-h-[400px]">
                            <div className="p-2 border-b border-slate-100 flex gap-2 bg-slate-50">
                                <button onClick={selectAll} className="flex-1 text-xs bg-white border hover:bg-slate-50 text-slate-600 px-2 py-1 rounded">Marcar Todos</button>
                                <button onClick={deselectAll} className="flex-1 text-xs bg-white border hover:bg-slate-50 text-slate-600 px-2 py-1 rounded">Desmarcar</button>
                            </div>
                            <div className="overflow-y-auto p-2 space-y-1">
                                <label className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer checkbox-wrapper group">
                                    <input type="checkbox" className="hidden" checked={selectedIds.has('null')} onChange={() => toggleSelection('null')}/>
                                    <div className="w-5 h-5 border-2 border-slate-300 rounded flex items-center justify-center bg-white transition-colors group-hover:border-indigo-400"><IconCheck size={12} className="text-white hidden"/></div>
                                    <span className="text-sm text-slate-700 italic">-- Sin Instrumento --</span>
                                </label>
                                <hr className="border-slate-100 my-1"/>
                                {catalogo.map(inst => (
                                    <label key={inst.id} className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer checkbox-wrapper group">
                                        <input type="checkbox" className="hidden" checked={selectedIds.has(inst.id)} onChange={() => toggleSelection(inst.id)}/>
                                        <div className="w-5 h-5 border-2 border-slate-300 rounded flex items-center justify-center bg-white transition-colors group-hover:border-indigo-400"><IconCheck size={12} className="text-white hidden"/></div>
                                        <span className="text-sm text-slate-700">{inst.instrumento}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PESTAÑA: GESTIÓN DE ENSAMBLES (NUEVA INTERFAZ) ---
        const EnsemblesView = ({ supabase }) => {
            const [ensembles, setEnsembles] = useState([]);
            const [selectedEnsemble, setSelectedEnsemble] = useState(null);
            
            // Estado para la gestión de miembros
            const [allMusicians, setAllMusicians] = useState([]);
            const [memberIds, setMemberIds] = useState(new Set()); 
            const [searchText, setSearchText] = useState("");
            
            const [loadingMembers, setLoadingMembers] = useState(false);
            const [togglingId, setTogglingId] = useState(null); 

            // Estado para Edición de Header de Ensamble
            const [isEditingHeader, setIsEditingHeader] = useState(false);
            const [headerForm, setHeaderForm] = useState({ ensamble: '', descripcion: '' });

            // 1. Cargar Ensambles y Lista Maestra de Músicos
            useEffect(() => {
                fetchEnsembles();
                fetchAllMusicians();
            }, []);

            // 2. Cargar Miembros al seleccionar un Ensamble
            useEffect(() => {
                if (selectedEnsemble) {
                    fetchEnsembleMembers(selectedEnsemble.id);
                    // Resetear modo edición
                    setIsEditingHeader(false);
                    setHeaderForm({ ensamble: selectedEnsemble.ensamble, descripcion: selectedEnsemble.descripcion || '' });
                } else {
                    setMemberIds(new Set());
                }
            }, [selectedEnsemble]);

            const fetchEnsembles = async () => {
                const { data, error } = await supabase.from('ensambles').select('*').order('ensamble');
                if (!error) setEnsembles(data || []);
            };

            const fetchAllMusicians = async () => {
                const { data, error } = await supabase
                    .from('integrantes')
                    .select('id, nombre, apellido, instrumentos(instrumento)')
                    .order('apellido');
                if (!error) setAllMusicians(data || []);
            };

            const fetchEnsembleMembers = async (ensambleId) => {
                setLoadingMembers(true);
                const { data, error } = await supabase
                    .from('integrantes_ensambles')
                    .select('id_integrante') 
                    .eq('id_ensamble', ensambleId);
                
                if (error) {
                    console.error("Error cargando miembros:", error);
                } else if (data) {
                    const ids = new Set(data.map(row => row.id_integrante));
                    setMemberIds(ids);
                }
                setLoadingMembers(false);
            };

            // Generador de ID aleatorio para Ensambles
            const generateEnsembleId = () => Math.floor(100 + Math.random() * 900000); 

            // Crear nuevo ensamble
            const createEnsemble = async () => {
                const nombreDefault = "Nuevo Ensamble " + (ensembles.length + 1);
                const newId = generateEnsembleId();
                const { data, error } = await supabase
                    .from('ensambles')
                    .insert([{ 
                        id: newId,
                        ensamble: nombreDefault, 
                        descripcion: 'Descripción del ensamble' 
                    }])
                    .select();

                if (error) {
                    alert("Error al crear: " + error.message);
                } else if (data && data.length > 0) {
                    await fetchEnsembles();
                    setSelectedEnsemble(data[0]); // Seleccionar el nuevo
                }
            };

            // Eliminar ensamble
            const deleteEnsemble = async (id, e) => {
                e.stopPropagation(); // Evitar seleccionar al hacer click en borrar
                if (!confirm("¿Estás seguro de eliminar este ensamble? Se desvincularán los músicos.")) return;

                // Primero borramos relaciones (si no hay cascade configurado en DB)
                await supabase.from('integrantes_ensambles').delete().eq('id_ensamble', id);
                
                // Luego borramos el ensamble
                const { error } = await supabase.from('ensambles').delete().eq('id', id);

                if (error) {
                    alert("Error al eliminar: " + error.message);
                } else {
                    if (selectedEnsemble?.id === id) setSelectedEnsemble(null);
                    fetchEnsembles();
                }
            };

            // Guardar edición de cabecera
            const saveHeader = async () => {
                if (!selectedEnsemble) return;
                
                const { error } = await supabase
                    .from('ensambles')
                    .update({ ensamble: headerForm.ensamble, descripcion: headerForm.descripcion })
                    .eq('id', selectedEnsemble.id);

                if (error) {
                    alert("Error al actualizar: " + error.message);
                } else {
                    setIsEditingHeader(false);
                    fetchEnsembles(); // Actualizar lista lateral
                    // Actualizar obj seleccionado localmente para reflejo inmediato
                    setSelectedEnsemble({ ...selectedEnsemble, ...headerForm });
                }
            };

            const toggleMembership = async (musicianId) => {
                if (!selectedEnsemble) return;
                setTogglingId(musicianId); 

                const isMember = memberIds.has(musicianId);
                const ensambleIdInt = parseInt(selectedEnsemble.id, 10);
                const musicianIdInt = parseInt(musicianId, 10);

                let error = null;

                if (isMember) {
                    const { error: err } = await supabase
                        .from('integrantes_ensambles')
                        .delete()
                        .eq('id_ensamble', ensambleIdInt)
                        .eq('id_integrante', musicianIdInt);
                    error = err;
                } else {
                    const { error: err } = await supabase
                        .from('integrantes_ensambles')
                        .insert([{ id_ensamble: ensambleIdInt, id_integrante: musicianIdInt }]);
                    error = err;
                }

                if (error) {
                    console.error("Error toggle:", error);
                    alert(`Error al actualizar: ${error.message}`);
                } else {
                    const newSet = new Set(memberIds);
                    if (isMember) newSet.delete(musicianId);
                    else newSet.add(musicianId);
                    setMemberIds(newSet);
                }
                setTogglingId(null);
            };

            const filteredMusicians = allMusicians
                .filter(m => {
                    const term = searchText.toLowerCase();
                    const fullName = `${m.nombre} ${m.apellido}`.toLowerCase();
                    const instrument = m.instrumentos?.instrumento?.toLowerCase() || '';
                    return fullName.includes(term) || instrument.includes(term);
                })
                .sort((a, b) => {
                    const isMemberA = memberIds.has(a.id);
                    const isMemberB = memberIds.has(b.id);
                    if (isMemberA && !isMemberB) return -1;
                    if (!isMemberA && isMemberB) return 1;
                    return (a.apellido || '').localeCompare(b.apellido || '');
                });

            const firstNonMemberIndex = filteredMusicians.findIndex(m => !memberIds.has(m.id));

            return (
                <div className="flex h-full gap-6">
                    {/* COLUMNA IZQUIERDA: Lista de Ensambles */}
                    <div className="w-1/3 min-w-[250px] flex flex-col gap-4 border-r border-slate-200 pr-6 overflow-y-auto">
                        <div className="flex items-center justify-between mb-2">
                            <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <IconLayers className="text-indigo-600"/> Ensambles
                            </h2>
                            <button 
                                onClick={createEnsemble}
                                className="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700 flex items-center gap-1 shadow-sm"
                            >
                                <IconPlus size={14}/> Nuevo
                            </button>
                        </div>
                        <div className="space-y-2">
                            {ensembles.map(ens => (
                                <div key={ens.id} className="group relative">
                                    <button
                                        onClick={() => setSelectedEnsemble(ens)}
                                        className={`w-full text-left p-4 rounded-xl border transition-all pr-10 ${
                                            selectedEnsemble?.id === ens.id 
                                            ? 'bg-indigo-600 text-white border-indigo-600 shadow-md ring-2 ring-indigo-200' 
                                            : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:bg-slate-50'
                                        }`}
                                    >
                                        <div className="font-bold text-lg truncate">{ens.ensamble}</div>
                                        {ens.descripcion && (
                                            <div className={`text-xs mt-1 truncate ${selectedEnsemble?.id === ens.id ? 'text-indigo-200' : 'text-slate-400'}`}>
                                                {ens.descripcion}
                                            </div>
                                        )}
                                    </button>
                                    {/* Botón Eliminar (Siempre visible pero sutil) */}
                                    <button 
                                        onClick={(e) => deleteEnsemble(ens.id, e)}
                                        className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg transition-all ${
                                            selectedEnsemble?.id === ens.id 
                                                ? 'text-white/70 hover:text-white hover:bg-white/20' 
                                                : 'text-slate-300 hover:text-red-500 hover:bg-red-50'
                                        }`}
                                        title="Eliminar Ensamble"
                                    >
                                        <IconTrash size={16} />
                                    </button>
                                </div>
                            ))}
                            {ensembles.length === 0 && (
                                <div className="text-center p-8 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 text-sm">
                                    No hay ensambles.<br/>Crea uno para empezar.
                                </div>
                            )}
                        </div>
                    </div>

                    {/* COLUMNA DERECHA: Gestor de Miembros */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden bg-white rounded-xl shadow-sm border border-slate-200">
                        {selectedEnsemble ? (
                            <>
                                {/* Cabecera del Ensamble Editable */}
                                <div className="p-6 border-b border-slate-100 bg-slate-50">
                                    {isEditingHeader ? (
                                        <div className="space-y-3 animate-in fade-in duration-200">
                                            <input 
                                                type="text" 
                                                className="w-full text-2xl font-bold border border-indigo-300 rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 outline-none"
                                                value={headerForm.ensamble}
                                                onChange={(e) => setHeaderForm({...headerForm, ensamble: e.target.value})}
                                                placeholder="Nombre del Ensamble"
                                            />
                                            <textarea 
                                                className="w-full text-sm border border-indigo-300 rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-20"
                                                value={headerForm.descripcion}
                                                onChange={(e) => setHeaderForm({...headerForm, descripcion: e.target.value})}
                                                placeholder="Descripción del ensamble..."
                                            />
                                            <div className="flex gap-2 justify-end">
                                                <button onClick={() => setIsEditingHeader(false)} className="px-3 py-1 bg-white border rounded text-sm hover:bg-slate-50">Cancelar</button>
                                                <button onClick={saveHeader} className="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Guardar</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="group relative">
                                            <div className="flex items-start justify-between">
                                                <div>
                                                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                                        {selectedEnsemble.ensamble}
                                                        <button 
                                                            onClick={() => setIsEditingHeader(true)}
                                                            className="text-slate-300 hover:text-indigo-500 transition-colors opacity-0 group-hover:opacity-100"
                                                            title="Editar Nombre/Descripción"
                                                        >
                                                            <IconEdit size={18} />
                                                        </button>
                                                    </h2>
                                                    <p className="text-slate-500 text-sm mb-4 mt-1">
                                                        {selectedEnsemble.descripcion || <span className="italic text-slate-400">Sin descripción</span>}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            {/* Barra de Búsqueda de Músicos */}
                                            <div className="relative mt-2">
                                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                                    <IconSearch size={18} />
                                                </div>
                                                <input 
                                                    type="text" 
                                                    className="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                                    placeholder="Buscar músico para agregar/quitar..."
                                                    value={searchText}
                                                    onChange={(e) => setSearchText(e.target.value)}
                                                />
                                            </div>
                                            <div className="flex justify-between items-center mt-2 text-xs text-slate-400">
                                                <span>Total músicos encontrados: {filteredMusicians.length}</span>
                                                <span>Miembros actuales: {memberIds.size}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* LISTA DE MÚSICOS CON CHECKBOX */}
                                <div className="flex-1 overflow-y-auto p-2 bg-slate-50/50">
                                    {loadingMembers ? (
                                        <div className="flex items-center justify-center h-full text-indigo-600 gap-2">
                                            <IconLoader size={24}/> Cargando miembros...
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {filteredMusicians.map((musician, index) => {
                                                const isMember = memberIds.has(musician.id);
                                                const isToggling = togglingId === musician.id;
                                                const showSeparator = index === firstNonMemberIndex && index > 0;

                                                return (
                                                    <React.Fragment key={musician.id}>
                                                        {showSeparator && (
                                                            <div className="relative py-4 text-center">
                                                                <div className="absolute inset-0 flex items-center" aria-hidden="true">
                                                                    <div className="w-full border-t border-slate-300"></div>
                                                                </div>
                                                                <div className="relative flex justify-center">
                                                                    <span className="bg-slate-50 px-2 text-xs text-slate-500 uppercase tracking-wide font-semibold">Músicos Disponibles</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div 
                                                            onClick={() => !isToggling && toggleMembership(musician.id)}
                                                            className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all select-none ${
                                                                isMember 
                                                                    ? 'bg-indigo-50 border-indigo-200 shadow-sm z-10' 
                                                                    : 'bg-white border-slate-200 hover:border-indigo-300'
                                                            }`}
                                                        >
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-6 h-6 rounded border flex items-center justify-center transition-colors ${
                                                                    isMember ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'
                                                                }`}>
                                                                    {isToggling ? (
                                                                        <IconLoader size={14} className={isMember ? "text-white" : "text-indigo-600"}/>
                                                                    ) : (
                                                                        isMember && <IconCheck size={14} className="text-white"/>
                                                                    )}
                                                                </div>
                                                                
                                                                <div>
                                                                    <div className={`font-bold ${isMember ? 'text-indigo-900' : 'text-slate-700'}`}>
                                                                        {musician.apellido}, {musician.nombre}
                                                                    </div>
                                                                    <div className="text-xs text-slate-500 flex items-center gap-1">
                                                                        <IconMusic size={10}/> 
                                                                        {musician.instrumentos?.instrumento || 'Sin instrumento'}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {isMember && (
                                                                <span className="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-100">
                                                                    MIEMBRO
                                                                </span>
                                                            )}
                                                        </div>
                                                    </React.Fragment>
                                                );
                                            })}
                                            {filteredMusicians.length === 0 && (
                                                <div className="text-center py-10 text-slate-400 italic">No se encontraron músicos con ese nombre.</div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-300">
                                <IconLayers size={64} className="mb-4 opacity-20"/>
                                <p className="text-lg font-medium">Selecciona un ensamble para gestionar</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PESTAÑA: GESTIÓN DE MÚSICOS ---
        const MusiciansView = ({ supabase, catalogoInstrumentos }) => {
            const [resultados, setResultados] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [searchText, setSearchText] = useState("");
            const [selectedInstruments, setSelectedInstruments] = useState(new Set()); 
            const [editingId, setEditingId] = useState(null);
            const [editFormData, setEditFormData] = useState({ nombre: '', apellido: '', id_instr: '' });
            const [isAdding, setIsAdding] = useState(false);

            useEffect(() => {
                const allIds = new Set(catalogoInstrumentos.map(i => i.id));
                allIds.add('null');
                setSelectedInstruments(allIds);
                fetchData(supabase, "", allIds);
            }, [catalogoInstrumentos]);

            const fetchData = async (client = supabase, search = searchText, instruments = selectedInstruments) => {
                if (!client) return;
                setLoading(true);
                setError(null);
                setEditingId(null);
                try {
                    let query = client.from('integrantes').select('id, nombre, apellido, id_instr, instrumentos(instrumento)').order('apellido', { ascending: true });
                    if (search.trim()) {
                        const term = search.trim();
                        query = query.or(`nombre.ilike.%${term}%,apellido.ilike.%${term}%`);
                    }
                    const instrumentArray = Array.from(instruments);
                    const realIds = instrumentArray.filter(id => id !== 'null');
                    const includeNull = instruments.has('null');
                    if (realIds.length === 0 && !includeNull) { setResultados([]); setLoading(false); return; }
                    let orConditions = [];
                    if (realIds.length > 0) orConditions.push(`id_instr.in.(${realIds.join(',')})`);
                    if (includeNull) orConditions.push(`id_instr.is.null`);
                    if (orConditions.length > 0) query = query.or(orConditions.join(','));
                    const { data, error } = await query;
                    if (error) throw error;
                    setResultados(data || []);
                } catch (err) { setError("Error al cargar datos: " + err.message); } finally { setLoading(false); }
            };

            const handleSearch = (e) => { e.preventDefault(); fetchData(supabase, searchText, selectedInstruments); };
            const handleInstrumentChange = (newSet) => { setSelectedInstruments(newSet); fetchData(supabase, searchText, newSet); };
            
            const guardarEdicion = async (id) => {
                if (!supabase) return;
                setLoading(true);
                try {
                    const { error } = await supabase.from('integrantes').update({ nombre: editFormData.nombre, apellido: editFormData.apellido, id_instr: editFormData.id_instr || null }).eq('id', id);
                    if (error) throw error;
                    await fetchData(supabase, searchText, selectedInstruments);
                    setEditingId(null);
                } catch (err) { alert("Error al guardar: " + err.message); } finally { setLoading(false); }
            };

            const generateRandomId = () => {
                // Genera un número entre 10000000 y 99999999
                return Math.floor(10000000 + Math.random() * 90000000);
            };

            const crearIntegrante = async () => {
                if (!supabase) return;
                setLoading(true);
                try {
                    const newId = generateRandomId();
                    const { error } = await supabase.from('integrantes').insert([{ 
                        id: newId, // Asignamos ID aleatorio explícito
                        nombre: editFormData.nombre, 
                        apellido: editFormData.apellido, 
                        id_instr: editFormData.id_instr || null 
                    }]);
                    if (error) throw error;
                    setIsAdding(false);
                    setEditFormData({ nombre: '', apellido: '', id_instr: '' });
                    await fetchData(supabase, searchText, selectedInstruments);
                } catch (err) { alert("Error al crear: " + err.message); } finally { setLoading(false); }
            };

            const startEdit = (item) => { setEditingId(item.id); setEditFormData({ nombre: item.nombre || '', apellido: item.apellido || '', id_instr: item.id_instr || '' }); setIsAdding(false); };
            const startAdd = () => { setEditingId(null); setEditFormData({ nombre: '', apellido: '', id_instr: '' }); setIsAdding(true); };

            return (
                <div className="space-y-6 h-full flex flex-col overflow-hidden">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 shrink-0">
                        <div className="flex flex-col md:flex-row gap-4">
                            <form onSubmit={handleSearch} className="flex-1 relative">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><IconSearch size={18} /></div>
                                <input type="text" className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded hover:border-indigo-500 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Buscar por nombre o apellido..." value={searchText} onChange={(e) => setSearchText(e.target.value)} />
                            </form>
                            <div className="w-full md:w-auto min-w-[200px]">
                                <InstrumentFilter catalogo={catalogoInstrumentos} selectedIds={selectedInstruments} onChange={handleInstrumentChange} />
                            </div>
                        </div>
                        <div className="flex items-center justify-between text-xs text-slate-500 pt-2 mt-2 border-t border-slate-100">
                            <span>Mostrando {resultados.length} resultados</span>
                            {loading && <span className="text-indigo-600 font-medium">Actualizando...</span>}
                        </div>
                    </div>

                    {error && (<div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-start gap-3"><IconAlertCircle className="shrink-0 mt-0.5" /><div><p className="font-bold text-sm">Ocurrió un error</p><p className="text-sm opacity-90">{error}</p></div></div>)}

                    <div className="flex-1 overflow-y-auto space-y-3 pb-4 pr-2">
                        {!isAdding && (<button onClick={startAdd} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2 font-medium"><IconPlus size={20} /> Agregar Nuevo Integrante</button>)}
                        
                        {isAdding && (
                            <div className="bg-indigo-50 border border-indigo-200 p-4 rounded-xl shadow-sm animate-in fade-in slide-in-from-top-2">
                                <h3 className="text-indigo-900 font-bold mb-3 flex items-center gap-2"><IconPlus size={18}/> Nuevo Integrante (ID Auto: Generado)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                    <input type="text" placeholder="Nombre" className="border p-2 rounded" value={editFormData.nombre} onChange={e => setEditFormData({...editFormData, nombre: e.target.value})} />
                                    <input type="text" placeholder="Apellido" className="border p-2 rounded" value={editFormData.apellido} onChange={e => setEditFormData({...editFormData, apellido: e.target.value})} />
                                    <select className="border p-2 rounded bg-white" value={editFormData.id_instr} onChange={e => setEditFormData({...editFormData, id_instr: e.target.value})}>
                                        <option value="">-- Sin Instrumento --</option>
                                        {catalogoInstrumentos.map(i => <option key={i.id} value={i.id}>{i.instrumento}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-2 justify-end">
                                    <button onClick={() => setIsAdding(false)} className="px-4 py-2 bg-white border border-slate-300 rounded text-slate-700 hover:bg-slate-50 text-sm font-medium">Cancelar</button>
                                    <button onClick={crearIntegrante} disabled={loading} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-medium shadow-sm">Guardar</button>
                                </div>
                            </div>
                        )}

                        {resultados.map((item) => (
                            <div key={item.id} className={`bg-white p-4 rounded-xl border shadow-sm transition-all hover:shadow-md ${editingId === item.id ? 'ring-2 ring-indigo-500 border-indigo-500 z-10 relative' : 'border-slate-200'}`}>
                                {editingId === item.id ? (
                                    <div className="flex flex-col gap-3">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Nombre</label><input type="text" className="w-full border border-slate-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={editFormData.nombre} onChange={(e) => setEditFormData({...editFormData, nombre: e.target.value})}/></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Apellido</label><input type="text" className="w-full border border-slate-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={editFormData.apellido} onChange={(e) => setEditFormData({...editFormData, apellido: e.target.value})}/></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Instrumento</label><select className="w-full border border-slate-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none bg-white" value={editFormData.id_instr} onChange={(e) => setEditFormData({...editFormData, id_instr: e.target.value})}><option value="">-- Sin Asignar --</option>{catalogoInstrumentos.map(inst => (<option key={inst.id} value={inst.id}>{inst.instrumento}</option>))}</select></div>
                                        </div>
                                        <div className="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-100">
                                            <button onClick={() => setEditingId(null)} className="flex items-center gap-1 px-3 py-1.5 rounded text-slate-600 hover:bg-slate-100 text-sm font-medium"><IconX size={16}/> Cancelar</button>
                                            <button onClick={() => guardarEdicion(item.id)} disabled={loading} className="flex items-center gap-1 px-4 py-1.5 rounded bg-emerald-600 text-white hover:bg-emerald-700 text-sm font-medium shadow-sm"><IconCheck size={16}/> Guardar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex items-start gap-4">
                                        <div className={`p-3 rounded-full shrink-0 ${item.id_instr ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>{item.id_instr ? <IconMusic size={24}/> : <IconUsers size={24}/>}</div>
                                        <div className="flex-1 min-w-0 pt-1">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="text-lg font-bold text-slate-800 leading-tight">{item.apellido}, {item.nombre}</h3>
                                                    <p className="text-sm text-slate-500 mt-1 flex items-center gap-2"><span className={`px-2 py-0.5 rounded text-xs font-semibold ${item.instrumentos ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500'}`}>{item.instrumentos?.instrumento || 'Sin Instrumento'}</span> <span className="text-[10px] text-slate-300">ID: {item.id}</span></p>
                                                </div>
                                                <button onClick={() => startEdit(item)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Editar"><IconEdit size={20}/></button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                        {!loading &&resultados.length === 0 && (<div className="text-center py-12 px-4 border-2 border-dashed border-slate-200 rounded-xl"><div className="bg-slate-50 p-4 rounded-full inline-block mb-3"><IconSearch className="text-slate-400" size={32}/></div><h3 className="text-slate-600 font-bold">No se encontraron resultados</h3></div>)}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL APP ---
        function App() {
            const [supabase, setSupabase] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [catalogoInstrumentos, setCatalogoInstrumentos] = useState([]);
            const [currentView, setCurrentView] = useState('musicians'); // 'musicians' | 'ensembles'

            useEffect(() => {
                const initApp = async () => {
                    if (window.supabase) {
                        try {
                            const client = window.supabase.createClient(SB_URL, SB_KEY);
                            setSupabase(client);
                            setIsConnected(true);
                            const { data } = await client.from('instrumentos').select('id, instrumento').order('instrumento');
                            if (data) setCatalogoInstrumentos(data);
                        } catch (err) { console.error("Error init:", err); }
                    } else { setTimeout(initApp, 500); }
                };
                initApp();
            }, []);

            return (
                <div className="flex flex-col h-full">
                    {/* NAVBAR SUPERIOR */}
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm shrink-0">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-6">
                                <div className="flex items-center gap-2 text-indigo-700">
                                    <IconDatabase size={28}/>
                                    <h1 className="text-xl font-bold tracking-tight hidden sm:block">Orquesta Manager</h1>
                                </div>
                                {/* PESTAÑAS DE NAVEGACIÓN */}
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setCurrentView('musicians')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${currentView === 'musicians' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <IconUsers size={16}/> Músicos
                                    </button>
                                    <button 
                                        onClick={() => setCurrentView('ensembles')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${currentView === 'ensembles' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <IconLayers size={16}/> Ensambles
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {isConnected ? (
                                    <span className="flex items-center gap-1.5 text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100">
                                        <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> Conectado
                                    </span>
                                ) : ( <span className="text-xs text-slate-400">Conectando...</span> )}
                            </div>
                        </div>
                    </div>

                    {/* CONTENIDO PRINCIPAL */}
                    <div className="flex-1 overflow-hidden bg-slate-50">
                        <div className="max-w-6xl mx-auto px-4 py-6 h-full">
                            {isConnected && currentView === 'musicians' && (
                                <MusiciansView supabase={supabase} catalogoInstrumentos={catalogoInstrumentos} />
                            )}
                            {isConnected && currentView === 'ensembles' && (
                                <EnsemblesView supabase={supabase} catalogoInstrumentos={catalogoInstrumentos} />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>